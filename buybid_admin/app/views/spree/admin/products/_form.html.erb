
<div data-hook="admin_product_form_fields">

  <div class="row">

    <div class="col-xs-12 col-md-8" data-hook="admin_product_form_left">
      <div class="col-md-8">
        <div data-hook="admin_product_form_name">
          <%= f.field_container :name, class: ['form-group'] do %>
            <%= f.label :name, raw(Spree.t(:name) + content_tag(:span, ' *', class: 'required')) %>
            <%= f.text_field :name, class: 'form-control title' %>
            <%= f.error_message_on :name %>
          <% end %>
        </div>

        <div data-hook="admin_product_form_slug">
          <%= f.field_container :slug, class: ['form-group'] do %>
            <%= f.label :slug, raw(Spree.t(:slug)) %>
            <%= f.hidden_field :slug %>
            <%= f.text_field :slug, class: 'form-control title', disabled: true %>
            <%= f.error_message_on :slug %>
          <% end %>
        </div>
        
        <div data-hook="admin_product_form_seller">
          <%= f.field_container :buybid_seller, class: ['form-group'] do %>
            <%= f.label :buybid_seller_id, Spree.t(:seller) %>
            <%= f.collection_select(:buybid_seller_id, Buybid::Seller.all, :id, :name, { include_blank: Spree.t('match_choices.none') }, { class: 'select2' }) %>
            <%= f.error_message_on :buybid_seller %>
          <% end %>
        </div>

        <div data-hook="admin_product_form_taxons">
          <%= f.field_container :taxons, class: ['form-group'] do %>
            <%= f.label :taxon_ids, Spree.t(:categories) %>

            <% if can? :modify, Spree::Classification %>
              <%= f.hidden_field :taxon_ids, value: @product.taxon_ids.join(','), taxonomy_id: Spree::Taxonomy.where({ name: 'categories' }).first.id, placeholder: Spree.t(:placeholder_cateogries) %>
            <% elsif @product.taxons.any? %>
              <ul class="text_list">
                <% @product.taxons.each do |taxon| %>
                  <li><%= taxon.name %></li>
                <% end %>
              </ul>
            <% else %>
              <div class="alert alert-info"><%= Spree.t(:no_resource_found, resource: :taxons) %></div>
            <% end %>

          <% end %>
        </div>

        <div data-hook = "admin_product_form_business">
          <%= f.label :business, Spree.t(:business) %>
          <%= f.field_container :buybid_auction, class: ['form-group'], style: 'border: 1px solid #e0e0e0; padding: 8px 16px;' do %>
            <span id = "buybid_auction-field", style = "padding-right: 20px" >
              <%= f.error_message_on :buybid_auction %>
              <%= f.check_box :buybid_auction, checked: @product.buybid_auction?, style: "width: 20px; height: 20px"%>
              <%= f.label :buybid_auction, Spree.t(:auction) %>
            </span>
            <span id = "buybid_shop-field", style = "padding-right: 20px" >
              <%= f.error_message_on :buybid_shop %>
              <%= f.check_box :buybid_shop, checked: @product.buybid_shop?, style: "width: 20px; height: 20px"%>
              <%= f.label :buybid_shop, Spree.t(:shop) %>
            </span>
            <span id = "buybid_partner-field", style = "padding-right: 20px" >
              <%= f.error_message_on :buybid_partner %>
              <%= f.check_box :buybid_partner, checked: @product.buybid_partner?, style: "width: 20px; height: 20px"%>
              <%= f.label :buybid_partner, Spree.t(:partner) %>
            </span>
            <span id = "buybid_store-field", style = "padding-right: 20px" >
              <%= f.error_message_on :buybid_store %>
              <%= f.check_box :buybid_store, checked: @product.buybid_store?, style: "width: 20px; height: 20px"%>
              <%= f.label :buybid_store, Spree.t(:store) %>
            </span>
          <% end %>
        </div>

        <div data-hook="admin_product_form_trend">
          <%= f.label :trend, Spree.t(:trend) %>
          <%= f.field_container :buybid_hot, class: ['form-group'], style: 'border: 1px solid #e0e0e0; padding: 8px 16px;' do %>
            <span id = "buybid_hot-field", style = "padding-right: 20px" >
              <%= f.error_message_on :hots %>
              <%= f.check_box :buybid_hot, checked: @product.buybid_hot?, style: "width: 20px; height: 20px"%>
              <%= f.label :buybid_hot, Spree.t(:hot) %>
            </span>
            <span id = "buybid_new-field", style = "padding-right: 20px" >
              <%= f.error_message_on :buybid_new %>
              <%= f.check_box :buybid_new, checked: @product.buybid_new?, style: "width: 20px; height: 20px"%>
              <%= f.label :buybid_new, Spree.t(:new) %>
            </span>
            <span id = "buybid_popular-field", style = "padding-right: 20px" >
              <%= f.error_message_on :buybid_popular %>
              <%= f.check_box :buybid_popular, checked: @product.buybid_popular?, style: "width: 20px; height: 20px"%>
              <%= f.label :buybid_popular, Spree.t(:popular) %>
            </span>
          <% end %>
        </div>

        <div data-hook="admin_product_form_buybid_url_original">
          <%= f.field_container :buybid_url_original, class: ['form-group'] do %>
            <%= f.label :buybid_url_original, raw(Spree.t(:url_original)) %>
            <%= f.text_field :buybid_url_original, class: 'form-control title' %>
            <%= f.error_message_on :buybid_url_original %>
          <% end %>
        </div>
      </div>

      <div class="col-md-4">
        <div data-hook="admin_product_form_sku">
          <%= f.field_container :master_sku, class: ['form-group'] do %>
            <%= f.label :master_sku, raw(Spree.t(:sku) + content_tag(:span, ' *', class: "required")) %>
            <%= f.text_field :sku, size: 16, class: 'form-control' %>
          <% end %>
        </div>
        
        <div class="row">
          <div class="col-md-8" data-hook="admin_product_form_price">
            <%= f.field_container :price, class: ['form-group'] do %>
              <%= f.label :price, raw(Spree.t(:price) + content_tag(:span, ' *', class: "required")) %>
              <%= f.text_field :price, value: number_to_currency(@product.price, unit: ''), class: 'form-control', disabled: (cannot? :update, @product.price) %>
              <%= f.error_message_on :price %>
            <% end %>
          </div>

          <div class="col-md-4" data-hook="admin_product_form_cost_currency" class="omega two columns">
            <%= f.field_container :cost_currency, class: ['form-group'] do %>
              <%= f.label :cost_currency, Spree.t(:currency) %>
                <!-- <%= f.text_field :cost_currency, class: 'form-control' %> -->
                <select name="product[cost_currency]" id="product_cost_currency" class="select2">
                  <% ['JPY', 'VND', 'USD'].each do |currency| %>
                    <option value="<%= currency %>" <%= 'selected' if @product.cost_currency == currency %>><%= currency %></option>
                  <% end %>
                </select>

              <%= f.error_message_on :cost_currency %>
            <% end %>
          </div>

          <div class="col-md-12" data-hook="admin_product_price_in_vnd">
            Price in VND: <span class="price_in_vnd"></span>
            <script>
              
              function update_vnd_price() {
                let price = parseInt($('#product_price').val().replace(',', ''));
                let rate_to_vnd = BuybidAdmin.CurrencyRateToVND[$('#product_cost_currency').val()];

                $('.price_in_vnd').html(
                  BuybidAdmin.Utils.format_price(price * rate_to_vnd)
                );
              }

              update_vnd_price()
              $('#product_price').on('keyup', update_vnd_price)
              $('#product_cost_currency').on('change', update_vnd_price)

            </script>
          </div>
        </div>
        
        <!-- <div data-hook="admin_product_form_cost_price" class="alpha two columns">
          <%= f.field_container :cost_price, class: ['form-group'] do %>
            <%= f.label :cost_price, Spree.t(:cost_price) %>
            <%= f.text_field :cost_price, value: number_to_currency(@product.cost_price, unit: ''), class: 'form-control' %>
            <%= f.error_message_on :cost_price %>
          <% end %>
        </div> -->

        <div data-hook="admin_product_form_available_on">
          <%= f.field_container :available_on, class: ['form-group'] do %>
            <%= f.label :available_on, Spree.t(:available_on) %>
            <%= f.error_message_on :available_on %>
            <%= f.text_field :available_on, value: datepicker_field_value(@product.available_on), class: 'datepicker form-control', value: "#{Time.now.strftime('%Y/%m/%d')}" %>
          <% end %>
        </div>

        <div data-hook="admin_product_form_discontinue_on">
          <%= f.field_container :discontinue_on, class: ['form-group'] do %>
            <%= f.label :discontinue_on, Spree.t(:discontinue_on) %>
            <%= f.error_message_on :discontinue_on %>
            <%= f.text_field :discontinue_on, value: datepicker_field_value(@product.discontinue_on), class: 'datepicker form-control' %>
          <% end %>
        </div>
        
        <div class="row">
          <div class="col-md-8" data-hook="admin_product_form_buybid_position">
            <%= f.field_container :buybid_position, class: ['form-group'] do %>
              <%= f.label :buybid_position, raw(Spree.t(:position)) %>
              <%= f.text_field :buybid_position, class: 'form-control title' %>
              <%= f.error_message_on :buybid_position %>
            <% end %>
          </div>

          <div class="col-md-4" data-hook="admin_product_form_visible">
            <%= f.label :buybid_visible, Spree.t(:visible) %> 
            <%= f.field_container :buybid_visible, class: ['form-group'] do %>
              <%= f.check_box :buybid_visible, class: 'form-control title', checked: @product.buybid_visible?, style: "width: 32px; height: 32px"%>
              <%= f.error_message_on :buybid_visible %>
            <% end %>
          </div>  
        </div>
        
      </div>

      <div class="col-md-12">
        <div data-hook="admin_product_form_description">
          <%= f.field_container :description, class: ['form-group'] do %>
            <%= f.label :description, Spree.t(:description) %>
            <%= f.text_area :description, { rows: "#{unless @product.has_variants? then '20' else '13' end}", class: 'form-control' } %>
            <%= f.error_message_on :description %>
          <% end %>
        </div>

        <!--<div data-hook="admin_product_form_option_types">
          <%= f.field_container :option_types, class: ['form-group'] do %>
            <%= f.label :option_type_ids, Spree.t(:option_types) %>

            <% if can? :modify, Spree::ProductOptionType %>
              <%= f.hidden_field :option_type_ids, value: @product.option_type_ids.join(',') %>
            <% elsif @product.option_types.any? %>
              <ul class="text_list">
                <% @product.option_types.each do |type| %>
                  <li><%= type.presentation %> (<%= type.name %>)</li>
                <% end %>
              </ul>
            <% else %>
              <div class="alert alert-info"><%= Spree.t(:no_resource_found, resource: :option_types) %></div>
            <% end %>
          <% end %>
        </div>-->

        <div data-hook="admin_product_form_tag_list">
          <%= f.field_container :tag_list, class: ['form-group'] do %>
            <%= f.label :tag_list, Spree.t(:tags) %>
            <%= f.hidden_field :tag_list, value: @product.tag_list.join(','), class: 'tag_picker' %>
          <% end %>
        </div>

        <div data-hook="admin_product_form_meta">
          <div data-hook="admin_product_form_meta_title">
            <%= f.field_container :meta_title, class: ['form-group'] do %>
              <%= f.label :meta_title, Spree.t(:meta_title) %>
              <%= f.text_field :meta_title, class: 'form-control' %>
            <% end %>
          </div>

          <div data-hook="admin_product_form_meta_keywords">
            <%= f.field_container :meta_keywords, class: ['form-group'] do %>
              <%= f.label :meta_keywords, Spree.t(:meta_keywords) %>
              <%= f.text_field :meta_keywords, class: 'form-control' %>
            <% end %>
          </div>

          <div data-hook="admin_product_form_meta_description">
            <%= f.field_container :meta_description, class: ['form-group'] do %>
              <%= f.label :meta_description, Spree.t(:meta_description) %>
              <%= f.text_area :meta_description, { rows: "#{unless @product.has_variants? then '20' else '13' end}", class: 'form-control' } %>
            <%= f.error_message_on :meta_description %>
            <% end %>
          </div>

          <div data-hook="admin_product_form_additional_fields"></div>

        </div>
      </div>
      
    </div>
    
    <!-- ==================================================================================================-->
    <!-- ======================================== RIGHT SIDE ==============================================-->
    <!-- ==================================================================================================-->

    <div class="col-xs-12 col-md-4" data-hook="admin_product_form_right">
      <div data-hook="admin_product_logo">
        <%= f.label :logo, class:"box__input box__input_logo" do %>
          <div class="box_preview box_preview_logo">
            <% if @product.images[0].present? %>
              <span style="margin: 0 auto;">
                <%= image_tag(main_app.url_for(@product.images[0].url(:large))) %>
              </span>
            <% else %>
              <svg class="box__icon" xmlns="http://www.w3.org/2000/svg" width="50" height="43" viewBox="0 0 50 43"><path d="M48.4 26.5c-.9 0-1.7.7-1.7 1.7v11.6h-43.3v-11.6c0-.9-.7-1.7-1.7-1.7s-1.7.7-1.7 1.7v13.2c0 .9.7 1.7 1.7 1.7h46.7c.9 0 1.7-.7 1.7-1.7v-13.2c0-1-.7-1.7-1.7-1.7zm-24.5 6.1c.3.3.8.5 1.2.5.4 0 .9-.2 1.2-.5l10-11.6c.7-.7.7-1.7 0-2.4s-1.7-.7-2.4 0l-7.1 8.3v-25.3c0-.9-.7-1.7-1.7-1.7s-1.7.7-1.7 1.7v25.3l-7.1-8.3c-.7-.7-1.7-.7-2.4 0s-.7 1.7 0 2.4l10 11.6z"/></svg>
            <% end %>
          </div>

          <div class="files_label text-center">
            <strong>Product LOGO</strong>
          </div>
          
          <%= f.file_field :logo, class:"box__file files_input", multiple: false, accept: "image/png" %>
        <% end %>
      </div>

      <!-- Existing images -->
      <% unless @product.images.empty? %>
        <%= render partial: "spree/admin/images/index" %>
      <% end %>

      <!-- Drag & drop image -->
      <div data-hook="admin_product_form_files" class="files_container">
        <%= f.label :attachment, class:"box__input box__input_multiple" do %>
          <svg class="box__icon" xmlns="http://www.w3.org/2000/svg" width="50" height="43" viewBox="0 0 50 43"><path d="M48.4 26.5c-.9 0-1.7.7-1.7 1.7v11.6h-43.3v-11.6c0-.9-.7-1.7-1.7-1.7s-1.7.7-1.7 1.7v13.2c0 .9.7 1.7 1.7 1.7h46.7c.9 0 1.7-.7 1.7-1.7v-13.2c0-1-.7-1.7-1.7-1.7zm-24.5 6.1c.3.3.8.5 1.2.5.4 0 .9-.2 1.2-.5l10-11.6c.7-.7.7-1.7 0-2.4s-1.7-.7-2.4 0l-7.1 8.3v-25.3c0-.9-.7-1.7-1.7-1.7s-1.7.7-1.7 1.7v25.3l-7.1-8.3c-.7-.7-1.7-.7-2.4 0s-.7 1.7 0 2.4l10 11.6z"/></svg>
          
          <div class="files_label">
            <strong>Choose images</strong><span class="box__dragndrop"> or drag it here</span>
          </div>
          
          <%= f.file_field :attachment, class:"box__file files_input", multiple: true, accept: "image/png" %>
        <% end %>
      </div>
      
      <div class="box_preview box_preview_multiple"></div>

      <!--<div data-hook="admin_product_form_promotionable">
        <%= f.field_container :promotionable, class: ['form-group'] do %>
          <%= f.label :promotionable, Spree.t(:promotionable) %>
          <%= f.error_message_on :promotionable %>
          <%= f.check_box :promotionable, class: 'form-control' %>
        <% end %>
      </div>-->

      <!--<% if @product.has_variants? %>
        <div data-hook="admin_product_form_multiple_variants" class="well">
          <%= f.label :skus, Spree.t(:sku).pluralize %>
          <div class="info marginb">
            <%= Spree.t(:info_product_has_multiple_skus, count: @product.variants.size) %>
            <ul class="text_list">
              <% @product.variants.first(5).each do |variant| %>
                <li><%= variant.sku %></li>
              <% end %>
            </ul>
            <% if @product.variants.size > 5 %>
              <em>
                <%= Spree.t(:info_number_of_skus_not_shown, count: @product.variants.size - 5) %>
              </em>
            <% end %>
          </div>
          <div class="info-actions">
            <% if can?(:admin, Spree::Variant) %>
              <%= link_to_with_icon 'variants', Spree.t(:manage_variants), spree.admin_product_variants_url(@product), class: "btn btn-default" %>
            <% end %>
          </div>
        </div>
      <% else %>
        <div id="shipping_specs" class="row">
          <div class="col-xs-12 col-md-6">
            <div id="shipping_specs_weight_field" data-hook="admin_product_form_weight" class="form-group">
              <%= f.label :weight, Spree.t(:weight) %>
              <%= f.text_field :weight, value: number_with_precision(@product.weight, precision: 2), size: 4, class: 'form-control' %>
            </div>
          </div>

          <div class="col-xs-12 col-md-6">
            <div id="shipping_specs_height_field" data-hook="admin_product_form_height" class="form-group">
              <%= f.label :height, Spree.t(:height) %>
              <%= f.text_field :height, value: number_with_precision(@product.height, precision: 2), size: 4, class: 'form-control' %>
            </div>
          </div>

          <div class="col-xs-12 col-md-6">
            <div id="shipping_specs_width_field" data-hook="admin_product_form_width" class="form-group">
              <%= f.label :width, Spree.t(:width) %>
              <%= f.text_field :width, value: number_with_precision(@product.width, precision: 2), size: 4, class: 'form-control' %>
            </div>
          </div>

          <div class="col-xs-12 col-md-6">
            <div id="shipping_specs_depth_field" data-hook="admin_product_form_depth" class="form-group">
              <%= f.label :depth, Spree.t(:depth) %>
              <%= f.text_field :depth, value: number_with_precision(@product.depth, precision: 2), size: 4, class: 'form-control' %>
            </div>
          </div>
        </div>
      <% end %>

      <div data-hook="admin_product_form_shipping_categories">
        <%= f.field_container :shipping_category, class: ['form-group'] do %>
          <%= f.label :shipping_category_id, Spree.t(:shipping_category) %>
          <%= f.collection_select(:shipping_category_id, @shipping_categories, :id, :name, { include_blank: Spree.t('match_choices.none') }, { class: 'select2' }) %>
          <%= f.error_message_on :shipping_category %>
        <% end %>
      </div>

      <div data-hook="admin_product_form_tax_category">
        <%= f.field_container :tax_category, class: ['form-group'] do %>
          <%= f.label :tax_category_id, Spree.t(:tax_category) %>
          <%= f.collection_select(:tax_category_id, @tax_categories, :id, :name, { include_blank: Spree.t('match_choices.none') }, { class: 'select2' }) %>
          <%= f.error_message_on :tax_category %>
        <% end %>
      </div>-->
      <input type='hidden' name='product[shipping_category_id]' value='<%= @shipping_categories.first.id %>'>
      <input type='hidden' name='product[tax_category_id]' value='<%= @tax_categories.first.id %>'>
    </div>

  </div>
</div>

<script>
$(document).ready(function () {
  const box_multiple = document.querySelector('.box__input_multiple');
  const box_logo = document.querySelector('.box__input_logo');

  BuybidAdmin.Utils.register_drag_drop_images(box_multiple, show_producy_images, valid_product_images);
  BuybidAdmin.Utils.register_drag_drop_images(box_logo, show_product_logo, valid_product_images);

  function count_existing_image() {
    return document.querySelectorAll('table[data-hook="images_table"] tbody tr').length || 0;
  }

  function valid_product_images(files) {
    if (files.length > BuybidAdmin.FILE_COUNT_LIMIT - count_existing_image()){
      alert(`Product can\'t not have more than ${BuybidAdmin.FILE_COUNT_LIMIT} images.\n${files.length} is selected.`);
      return false;
    }

    return Array.from(files)
      .every(file => {
        if (file.type === 'image/png' && file.size <= BuybidAdmin.FILE_SIZE_LIMIT) {
          return true;
        } else {
          alert(`Invalid file: ${file.name}\nSize: ${file.size}\nType: ${file.type}`);
          return false;
        }
      });
  }

  function show_product_logo(files) {
    let box_preview_logo = document.querySelector('.box_preview_logo');
    let file = files[0];

    if (file) {
      let reader  = new FileReader();

      reader.addEventListener("load", function () {
        box_preview_logo.innerHTML = `
          <span style="margin: 0 auto;">
            <img src="${reader.result}" alt="${file.name}">
          </span>
        `;
      }, false);

      reader.readAsDataURL(files[0]);
    }
  }

  function show_producy_images(files) {
    let box_preview_multiple = document.querySelector('.box_preview_multiple');
    let images_html = '';

    box_preview_multiple.innerHTML = '';
    box_preview_multiple.style.display = 'block';


    for (let i = 0; i < files.length; i++) {
      let file = files[i];

      let reader  = new FileReader();

      reader.addEventListener("load", function () {
        images_html += `
          <div class="frontpage_square">
            <img src="${reader.result}" alt="${file.name}">
            <span>${file.name}</span>
          </div>
        `;

        box_preview_multiple.innerHTML = images_html;
      }, false);

      reader.readAsDataURL(file);
    }
  }
})
</script>
